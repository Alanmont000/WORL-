<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>WORLΔ — Prototype (No Payments)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;background:#000;color:#e8f6ff;font-family:Inter,Arial,sans-serif;overflow:hidden}
    #splash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column}
    #logo{font-size:72px;font-weight:800;color:#bfefff}
    #enter{padding:12px 20px;border-radius:10px;background:linear-gradient(90deg,#1fb8ff,#7ef0c6);border:none;color:#032;cursor:pointer}
    #game{display:none;width:100%;height:100%;position:relative}
    #canvas{width:100%;height:100%}
    #hud{position:absolute;left:16px;top:16px;background:rgba(8,20,30,0.55);padding:10px;border-radius:8px}
    #players{position:absolute;right:16px;top:16px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;width:200px}
    #chat{position:absolute;left:16px;bottom:16px;width:320px;background:rgba(0,0,0,0.35);padding:8px;border-radius:8px}
    input,button{font-family:inherit}
    .portal-label{font-size:12px;color:#9fd4ee}
  </style>
</head>
<body>
  <div id="splash">
    <div id="logo">WORLΔ</div>
    <div style="margin:8px;color:#9fd4ee">Prototipo — Sin compras. Multijugador básico.</div>
    <div style="display:flex;gap:8px">
      <input id="name" placeholder="Tu nombre" />
      <button id="enter">Entrar al Nexo</button>
    </div>
    <div style="margin-top:10px;font-size:12px;color:#9fbfdc">Si no pones nombre entrarás como Invitado.</div>
  </div>

  <div id="game">
    <div id="canvas"></div>
    <div id="hud">
      <div>Jugador: <span id="player-name">Invitado</span></div>
      <div>Nivel: <span id="player-level">1</span></div>
      <div>Fragmentos: <span id="player-frags">120</span></div>
      <div style="margin-top:6px">
        <button id="to-nexo">Ir al Nexo</button>
        <button id="open-shop">Tienda</button>
      </div>
    </div>
    <div id="players"><strong>Jugadores</strong><div id="players-list"></div></div>
    <div id="chat">
      <div id="chat-log" style="height:120px;overflow:auto;margin-bottom:6px"></div>
      <input id="chat-in" placeholder="Escribe..." style="width:70%" />
      <button id="chat-send">Enviar</button>
    </div>
  </div>

  <!-- three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

  <script>
  // Client logic: connect websocket, render simple Nexo with 10 portals, allow moving camera and clicking portals
  let ws;
  let playerId = null;
  let playerName = 'Invitado';
  let userId = 0; // if registered, user id
  const players = {}; // id -> {x,y,z,username}

  document.getElementById('enter').addEventListener('click', ()=>{
    playerName = (document.getElementById('name').value || 'Invitado').slice(0,20);
    document.getElementById('splash').style.display='none';
    document.getElementById('game').style.display='block';
    document.getElementById('player-name').innerText = playerName;
    init();
    connectWS();
    refreshMe();
  });

  async function refreshMe(){
    try {
      const res = await fetch('/api/me?userId=' + userId);
      const j = await res.json();
      if(j && j.user){
        document.getElementById('player-frags').innerText = j.user.fragments;
        document.getElementById('player-level').innerText = j.user.level;
      }
    } catch(e){ console.warn('no /api/me'); }
  }

  function connectWS(){
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = proto + '//' + location.host;
    ws = new WebSocket(url);
    ws.addEventListener('open', ()=> {
      ws.send(JSON.stringify({ t:'join', username: playerName, userId: userId }));
    });
    ws.addEventListener('message', (ev)=>{
      let data = JSON.parse(ev.data);
      if(data.t === 'welcome'){ playerId = data.id; }
      else if(data.t === 'players'){ updatePlayersList(data.list); }
      else if(data.t === 'pos'){ players[data.id] = { x:data.x,y:data.y,z:data.z,username:data.username }; }
      else if(data.t === 'chat'){ addChat(`${data.username}: ${data.text}`); }
    });
  }

  function updatePlayersList(list){
    const el = document.getElementById('players-list');
    el.innerHTML = '';
    list.forEach(p => {
      const d = document.createElement('div'); d.innerText = p.username + (p.userId? ' (u'+p.userId+')':'');
      el.appendChild(d);
    });
  }

  function addChat(txt){
    const log = document.getElementById('chat-log');
    const d = document.createElement('div'); d.innerText = txt;
    log.appendChild(d); log.scrollTop = log.scrollHeight;
  }

  document.getElementById('chat-send').addEventListener('click', ()=>{
    const t = document.getElementById('chat-in').value;
    if(!t) return;
    ws.send(JSON.stringify({ t:'chat', text: t }));
    document.getElementById('chat-in').value = '';
  });

  // Three.js scene
  function init(){
    const container = document.getElementById('canvas');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(0,6,12);
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.target.set(0,2,0); controls.update();

    scene.add(new THREE.AmbientLight(0x88cfff,0.8));
    const dir = new THREE.DirectionalLight(0xffffff,0.4); dir.position.set(5,10,2); scene.add(dir);

    const floor = new THREE.Mesh(new THREE.CircleGeometry(20,64), new THREE.MeshStandardMaterial({ color:0x051628, emissive:0x00253a }));
    floor.rotation.x = -Math.PI/2; scene.add(floor);

    const mon = new THREE.Mesh(new THREE.OctahedronGeometry(2.1,0), new THREE.MeshPhysicalMaterial({ color:0x1fb8ff, emissive:0x0a4360, transparent:true, opacity:0.95 }));
    mon.position.set(0,2.8,0); scene.add(mon);

    const portalInfos = [
      { name:'Mundo 1 - Disparos', pos:[-12,0,-4], color:0x3dd1ff },
      { name:'Mundo 2 - Construcción', pos:[-8,0,-12], color:0x8fffb3 },
      { name:'Mundo 3 - Carreras', pos:[-2,0,-16], color:0xffd86b },
      { name:'Mundo 4 - Supervivencia', pos:[4,0,-14], color:0x66ffd9 },
      { name:'Mundo 5 - Tecnológico', pos:[10,0,-8], color:0xff8aa6 },
      { name:'Mundo 6 - Gestión', pos:[14,0,-2], color:0xc8a6ff },
      { name:'Mundo 7 - Exploración', pos:[12,0,6], color:0x88d6ff },
      { name:'Mundo 8 - Fantástico', pos:[6,0,12], color:0xffa863 },
      { name:'Mundo 9 - Roleplay', pos:[-4,0,14], color:0x9fe7ff },
      { name:'Mundo 10 - Campaña', pos:[-12,0,8], color:0xffc36b }
    ];
    const portals = [];
    portalInfos.forEach((p,i)=>{
      const ring = new THREE.Mesh(new THREE.TorusGeometry(2.2,0.25,16,64), new THREE.MeshBasicMaterial({ color:p.color, transparent:true, opacity:0.5 }));
      ring.position.set(...p.pos); ring.rotation.x = Math.PI/2.2; ring.userData = { i }; scene.add(ring);
      portals.push(ring);
      const canvas = document.createElement('canvas'); canvas.width=256; canvas.height=64;
      const ctx = canvas.getContext('2d'); ctx.fillStyle='rgba(10,20,30,0.6)'; ctx.fillRect(0,0,256,64);
      ctx.fillStyle='#e9fbff'; ctx.font='16px Arial'; ctx.fillText(p.name,10,36);
      const tx = new THREE.CanvasTexture(canvas);
      const pl = new THREE.Mesh(new THREE.PlaneGeometry(3,0.8), new THREE.MeshBasicMaterial({ map:tx, transparent:true }));
      pl.position.set(p.pos[0],1.6,p.pos[2]-0.2); scene.add(pl);
    });

    const geo = new THREE.BufferGeometry(); const cnt=300; const positions=new Float32Array(cnt*3);
    for(let i=0;i<cnt;i++){ positions[i*3+0]=(Math.random()-0.5)*40; positions[i*3+1]=Math.random()*8+1; positions[i*3+2]=(Math.random()-0.5)*40; }
    geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
    const parts = new THREE.Points(geo, new THREE.PointsMaterial({ size:0.06, color:0x88e6ff, opacity:0.6 }));
    scene.add(parts);

    const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    window.addEventListener('pointerdown',(ev)=>{ mouse.x=(ev.clientX/innerWidth)*2-1; mouse.y=-(ev.clientY/innerHeight)*2+1; ray.setFromCamera(mouse,camera);
      const hits = ray.intersectObjects(portals); if(hits.length){ const idx = hits[0].object.userData.i; goToWorld(idx); } });

    function goToWorld(idx){
      const info = portalInfos[idx];
      addChat('Viajando a '+info.name+' (simulado)');
      if(info.name.includes('Campaña')){
        const lvl = parseInt(document.getElementById('player-level').innerText || '1');
        if(lvl < 25){ addChat('Nivel insuficiente. Requiere nivel 25 para entrar a la campaña.'); return; }
        startCampaignTimer();
      }
    }

    function startCampaignTimer(){
      addChat('Campaña iniciada — objetivo: impedir robo de la Piedra del Nexo. Tiempo estimado: 40 minutos (simulado 2 min demo).');
      let remaining = 120;
      const iv = setInterval(()=>{
        remaining--; if(remaining<=0){ clearInterval(iv); addChat('Campaña completada (demo). Recompensa: 300 fragmentos'); creditFragments(300); }
      },1000);
    }

    function creditFragments(amount){
      fetch('/api/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: userId, xp: 1000, fragments: parseInt(document.getElementById('player-frags').innerText||'120') + amount }) })
      .then(()=> refreshMe()).catch(()=> { let f = parseInt(document.getElementById('player-frags').innerText||'120'); document.getElementById('player-frags').innerText = f + amount; });
    }

    function addChat(t){ const log=document.getElementById('chat-log'); const d=document.createElement('div'); d.innerText=t; log.appendChild(d); log.scrollTop=log.scrollHeight; }

    function animate(){ mon.rotation.y += 0.002; parts.rotation.y += 0.0003; portals.forEach((r,i)=> r.rotation.z += 0.003 + i*0.001); renderer.render(scene, camera); requestAnimationFrame(animate); }
    animate();

    window.addEventListener('resize', ()=>{ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });
  }
  </script>
</body>
</html>
